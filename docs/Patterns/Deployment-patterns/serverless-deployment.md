# Шаблон: Бессерверное развертывание

[Оригинал](https://microservices.io/patterns/deployment/serverless-deployment.html)

## Дано

Вы воспользовались шаблоном [Микросервисная архитектура](../Application-architecture-patterns/pattern-microservice-architecture.md) и
спроектировали свою систему как набор сервисов. Каждый сервис развертывается
как набор экземпляров сервиса для обеспечения пропускной способности и
доступности.

## Задача

Как оформить и развернуть сервисы?

## Дополнительные условия

* Сервисы написаны с использованием различных языков, фреймворков и
  версий фреймворков
* Каждый сервис состоит из нескольких экземпляров сервиса для обеспечения
  пропускной способности и доступности
* Сервис должен быть независимо развертываемым и масштабируемым
* Экземпляры сервиса должны быть изолированы друг от друга
* Вам нужно уметь быстро создавать и развертывать сервис
* Вы должны иметь возможность ограничивать ресурсы (ЦП и память),
  потребляемые сервисом.
* Вам необходимо отслеживать поведение каждого экземпляра сервиса
* Вы хотите, чтобы развертывание было надежным
* Вы должны развернуть приложение как можно более экономично

## Решение

Используйте инфраструктуру для развертывания, которая скрывает любую 
концепцию серверов (т. е. зарезервированных или предварительно 
выделенных ресурсов) — физических или виртуальных хостов либо контейнеров. 
Инфраструктура берёт код вашего сервиса и запускает его. Плата 
взимается за каждый запрос в зависимости от потребляемых ресурсов.

Чтобы развернуть свой сервис с использованием этого подхода, вы 
упаковываете код (например, в виде ZIP-файла), загружаете его в 
инфраструктуру развертывания и описываете желаемые характеристики 
производительности.

Инфраструктура для развертывания — это утилита, управляемая провайдером 
общедоступного облака. Обычно для изоляции сервисов используются 
контейнеры или виртуальные машины. Однако эти подробности скрыты от 
вас. Ни вы, ни кто-либо еще в вашей организации не несет ответственности 
за управление какой-либо низкоуровневой инфраструктурой, такой как 
операционные системы, виртуальные машины и т. д.

## Примеры

Существует несколько различных сред бессерверного развертывания:

* [AWS Lambda](https://aws.amazon.com/lambda/)
* [Google Cloud Functions](https://cloud.google.com/functions/docs)
* [Azure Functions](https://azure.microsoft.com/en-us/services/functions/)

Они предлагают схожую функциональность, но у AWS Lambda самый богатый 
набор функций. Функция AWS Lambda — это компонент без сохранения 
состояния, который вызывается для обработки событий. Чтобы создать 
функцию AWS Lambda, вы упаковываете NodeJS, Java или Python код для 
своего сервиса в ZIP-файл и загружаете его в AWS Lambda. Вы также указываете 
имя функции, которая обрабатывает события, а также ограничения по ресурсам.

Когда происходит событие, AWS Lambda находит бездействующий экземпляр 
вашей функции, запускает его, если он недоступен, и вызывает 
функцию-обработчик. AWS Lambda запускает достаточно экземпляров вашей 
функции, чтобы справиться с нагрузкой. Под капотом он использует 
контейнеры для изоляции каждого экземпляра лямбда-функции. Как и 
следовало ожидать, AWS Lambda запускает контейнеры на EC2 инстансах.

Существует четыре способа вызвать лямбда-функцию. Один из 
вариантов — настроить лямбда-функцию так, чтобы она вызывалась в ответ 
на событие, сгенерированное AWS сервисом, таким как S3, DynamoDB или 
Kinesis. Примерами событий могут быть:

* создан объект в S3 bucket
* создается, обновляется или удаляется элемент в таблице DynamoDB
* доступно для чтения сообщение из потока Kinesis
* получено электронное письмо с помощью сервиса электронной почты Simple

Еще один способ вызвать лямбда-функцию — настроить AWS Lambda Gateway 
для маршрутизации HTTP-запросов к ней. AWS Gateway преобразует 
HTTP-запрос в объект-событие, вызывает лямбда-функцию и генерирует 
HTTP-ответ на основе результата лямбда-функции.

Вы также можете явно вызвать свою лямбда-функцию с помощью API веб-сервиса
AWS Lambda. Ваше приложение, вызывающее лямбда-функцию, генерирует 
JSON объект, который передается лямбда-функции. Вызов веб-сервиса 
возвращает значение, получившееся в результате выполнения лямбды.

Четвертый способ вызова лямбда-функции — периодическое использование 
механизма, подобного cron. Например, вы можете указать AWS вызывать 
лямбда-функцию каждые пять минут.

Стоимость каждого вызова зависит от продолжительности вызова, которая 
измеряется с шагом в 100 миллисекунд, и потребляемой памяти.

## Преимущества и недостатки

К преимуществам бессерверного развертывания относятся:

* Это устраняет необходимость тратить время на недифференцированную 
  тяжелую работу по управлению низкоуровневой инфраструктурой. Вместо 
  этого вы можете сосредоточиться на своем коде

* Бессерверная инфраструктура развертывания чрезвычайно гибка. Он 
  автоматически масштабирует ваши сервисы, чтобы справиться с нагрузкой

* Вы платите за каждый запрос, а не за то, что может быть недоиспользовано 
  виртуальными машинами или контейнерами

К недостаткам бессерверного развертывания относятся:

* Существенные ограничения и сдерживающие факторы. Бессерверная среда 
  развертывания обычно имеет гораздо больше ограничений, чем инфраструктура 
  на основе виртуальных машин или контейнеров. Например, AWS Lambda 
  поддерживает только несколько языков. Он подходит только для 
  развертывания приложений без сохранения состояния, которые запускаются 
  в ответ на запрос. Вы не можете развернуть долго работающее приложение 
  с отслеживанием состояния, такое как база данных или брокер сообщений.

* Ограниченные «источники ввода» — лямбда-выражения могут отвечать только 
  на запросы из ограниченного набора источников ввода. AWS Lambda не 
  предназначен для запуска сервисов, которые, например, подписываются 
  на брокера сообщений, такого как RabbitMQ

* Приложения должны запускаться быстро — бессерверное развертывание не 
  вариант, если запуск сервиса занимает много времени

* Риск высокой задержки — время, необходимое инфраструктуре для 
  нахождения экземпляра вашей функции и инициализации функции, может 
  привести к значительной задержке. Более того, бессерверная 
  инфраструктура развертывания может реагировать только на увеличение 
  нагрузки. Вы не можете заблаговременно подготовить ресурсы. В результате 
  ваше приложение может изначально демонстрировать намного большую задержку 
  при внезапных значительных скачках нагрузки.

Инфраструктура для развертывания будет под капотом развертывать ваше 
приложение, используя один из других приведённых шаблонов. Скорее всего, 
она будет использовать шаблон [«По сервису на хосте»](single-service-per-host.md).

## Связанные шаблоны

* [Шаблон «Несколько экземпляров сервиса на хосте»](multiple-services-per-host.md) является 
  альтернативным решением по развёртыванию
* [Шаблон «По сервису на хосте»](single-service-per-host.md) является 
  альтернативным решением по развёртыванию